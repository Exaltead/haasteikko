name: Deploy backend to stg

on:
  push:
    branches:
      - main

env:
  AZURE_FUNCTIONAPP_NAME: "haasteikkostg-flex-api-hsvowedtubwye"
  AZURE_FUNCTIONAPP_PACKAGE_PATH: "./backend/deployment"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Setup GO
        uses: actions/setup-go@v5

      - name: Build binary
        run: |
          cd backend
          go mod download
          go mod tidy
          GOOS=linux GOARCH=amd64 go build -o backend
          mkdir -p deployment
          mv backend deployment/backend
          cp -r api deployment/
          cp host.json deployment/host.json

          cd deployment

          sed -i 's/\.exe//g' host.json

      - name: "Run to Azure Functions"
        uses: "Azure/functions-action@v1"
        id: "fa"
        with:
          sku: 'flexconsumption'
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE_STG }}
